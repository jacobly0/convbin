ifeq (@(TUP_PLATFORM),win32)
  EXE = .exe
endif
ifneq (@(TUP_PLATFORM),macosx)
  STRIP = strip --strip-all
endif

CC = gcc
ifdef CC
  CC = @(CC)
endif
CFLAGS += @(CFLAGS)
ifndef CFLAGS
  ifeq (@(DEBUG),y)
    CFLAGS += -O0 -g3
    STRIP =
  else
    CFLAGS += -O3 -g0 -DNDEBUG
  endif
  CFLAGS += -Wall -Wextra -Wshadow
  CFLAGS += -std=c89
endif
ifdef LOG_BUILD_LEVEL
  CFLAGS += -DLOG_BUILD_LEVEL=@(LOG_BUILD_LEVEL)
else
  CFLAGS += -DLOG_BUILD_LEVEL=3
endif

ifdef STRIP
  STRIP = @(STRIP)
endif

LD = $(CC)
ifdef LD
  LD = @(LD)
endif
LDFLAGS += @(LDFLAGS)

ifneq (@(LTO),n)
  CFLAGS += -flto
  LDFLAGS += -flto
endif

SOURCES += src/*.c
SOURCES += src/asm/*.c
SOURCES += src/deps/zx/zx7/*.c
SOURCES += src/deps/zx/zx0/*.c

: foreach src/*.c src/asm/*.c src/deps/zx/zx7/*.c src/deps/zx/zx0/*.c |> ^ CC %o^ $(CC) -c $(CFLAGS) %f -o %o |> %f.o {OBJ}
ifeq ($(STRIP),)
  : {OBJ} |> ^ LD %o^ $(LD) $(LDFLAGS) %f -o %o |> convbin$(EXE)
else
  : {OBJ} |> ^t LD %o^ $(LD) $(LDFLAGS) %f -o %o |> convbin_unstripped$(EXE)
  : *_unstripped$(EXE) |> ^ STRIP %o^ $(STRIP) %f -o %o |> %g$(EXE)
endif
